<!DOCTYPE html>
<html>
<head>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>Nairong Laptop Borrow</title> 
<link rel="stylesheet" href="style.css">
</head>

<body>

<h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏∏‡πä‡∏Ñ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≤‡∏¢‡πÇ‡∏£‡∏á</h1>

<div class="button-group">
  <button id="loginBtn">Login ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏•‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
</div>

<p id="userInfo"></p>

<div class="stats">
  <div class="stat-box available">
    üü¢ ‡∏ß‡πà‡∏≤‡∏á: <span id="availableCount">0</span>
  </div>
  <div class="stat-box borrowed">
    üî¥ ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°: <span id="borrowedCount">0</span>
  </div>
</div>

<h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏∏‡πä‡∏Ñ</h2>

<div id="laptopList"></div>

<script type="module">

import { initializeApp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { 
  getFirestore, 
  collection, 
  getDocs, 
  getDoc,
  doc, 
  updateDoc 
} 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let isAdmin = false;
let currentUser = null;

const firebaseConfig = {
  apiKey: "AIzaSyA_2zR_-aF-DTQgMzkuTht42Gb8Mv7BU04",
  authDomain: "authentication-c67a5.firebaseapp.com",
  projectId: "authentication-c67a5",
  storageBucket: "authentication-c67a5.firebasestorage.app",
  messagingSenderId: "705284877449",
  appId: "1:705284877449:web:d2f467de3596dd8fcc6a58"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getFirestore(app);

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userInfo = document.getElementById("userInfo");
const laptopList = document.getElementById("laptopList");
const availableCount = document.getElementById("availableCount");
const borrowedCount = document.getElementById("borrowedCount");

async function sendToSheet(action, laptopName) {
  const formData = new FormData();
  formData.append("name", currentUser.displayName || "");
  formData.append("email", currentUser.email);
  formData.append("laptop", laptopName);
  formData.append("date", new Date().toLocaleString("th-TH"));
  formData.append("action", action);

  await fetch("https://script.google.com/macros/s/AKfycbyDEtqPKZ_2KgrfGBT2fKNBs8U-d9Mcyjg_Xb_cgFJ8QsfO67VtIh0PemCpm4PSugh0KQ/exec", {
    method: "POST",
    body: formData
  });
}

async function loadLaptops() {
  const querySnapshot = await getDocs(collection(db, "laptops"));
  laptopList.innerHTML = "";

  let available = 0;
  let borrowed = 0;

  const docsArray = [];

  querySnapshot.forEach((docSnap) => {
    docsArray.push({
      id: docSnap.id,
      ...docSnap.data()
    });
  });

  docsArray.sort((a, b) => {
    const numA = parseInt(a.name.match(/\d+/)[0]);
    const numB = parseInt(b.name.match(/\d+/)[0]);
    return numA - numB;
  });

  docsArray.forEach((data) => {

    const status = (data.status || "").toLowerCase().trim();

    if (status === "available") {
      available++;
    } else if (status === "borrowed") {
      borrowed++;
    }

    const box = document.createElement("div");
    box.className = "laptop-card " + status;

    box.innerHTML = `
      <div class="laptop-name">${data.name}</div>
      ${
        status === "borrowed"
          ? `<div class="borrow-info">
              üë§ ${data.borrowedBy}<br>
              üïí ${data.borrowDate}
            </div>`
          : ""
      }
    `;

    box.onclick = async () => {
      if (!currentUser) return;

      const docRef = doc(db, "laptops", data.id);

      if (status === "available") {

        await updateDoc(docRef, {
          status: "borrowed",
          borrowedBy: currentUser.email,
          borrowDate: new Date().toLocaleString("th-TH")
        });

        await sendToSheet("BORROW", data.name);

      } else {

        if (data.borrowedBy === currentUser.email || isAdmin) {

          await updateDoc(docRef, {
            status: "available",
            borrowedBy: "",
            borrowDate: ""
          });

          await sendToSheet("RETURN", data.name);

        } else {
          alert("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡πÇ‡∏î‡∏¢‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô");
        }
      }

      loadLaptops();
    };

    laptopList.appendChild(box);
  });

  availableCount.textContent = available;
  borrowedCount.textContent = borrowed;
}

loginBtn.onclick = () => {
  signInWithPopup(auth, provider).catch(console.log);
};

onAuthStateChanged(auth, async (user) => {

  if (user && user.email.endsWith("@nairong.ac.th")) {

    currentUser = user;
    isAdmin = false;

    const userRef = doc(db, "users", user.email);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists() && userSnap.data().role === "admin") {
      isAdmin = true;
    }

    userInfo.innerHTML =
      "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß: " + user.email +
      (isAdmin ? " (ADMIN)" : "");

    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline";
    loadLaptops();

  } else {

    if (user) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏•‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!");
      signOut(auth);
    }

    currentUser = null;
    isAdmin = false;
    userInfo.innerHTML = "";
    loginBtn.style.display = "inline";
    logoutBtn.style.display = "none";
    laptopList.innerHTML = "";
    availableCount.textContent = 0;
    borrowedCount.textContent = 0;
  }
});

logoutBtn.onclick = () => {
  signOut(auth);
};

</script>

</body>
</html>
