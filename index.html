<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Nairong Laptop Borrow</title>
  
  <link rel="stylesheet" href="style.css">

</head>
<body>

<h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏∏‡πä‡∏Ñ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≤‡∏¢‡πÇ‡∏£‡∏á</h1>

<button id="loginBtn">Login ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏•‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
<button id="logoutBtn" style="display:none;">Logout</button>

<p id="userInfo"></p>

<h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏∏‡πä‡∏Ñ</h2>
<div id="laptopList" 
     style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;">
</div>

<script type="module">
  import { initializeApp } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import { 
    getFirestore, 
    collection, 
    getDocs, 
    doc, 
    updateDoc 
  } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA_2zR_-aF-DTQgMzkuTht42Gb8Mv7BU04",
    authDomain: "authentication-c67a5.firebaseapp.com",
    projectId: "authentication-c67a5",
    storageBucket: "authentication-c67a5.firebasestorage.app",
    messagingSenderId: "705284877449",
    appId: "1:705284877449:web:d2f467de3596dd8fcc6a58"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userInfo = document.getElementById("userInfo");
  const laptopList = document.getElementById("laptopList");

  let currentUser = null;

 async function loadLaptops() {
  const querySnapshot = await getDocs(collection(db, "laptops"));

  laptopList.innerHTML = "";

  // üî• ‡πÅ‡∏õ‡∏•‡∏á snapshot ‡πÄ‡∏õ‡πá‡∏ô array ‡∏Å‡πà‡∏≠‡∏ô
  const docsArray = [];

  querySnapshot.forEach((docSnap) => {
    docsArray.push({
      id: docSnap.id,
      ...docSnap.data()
    });
  });

  // üî• ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
  docsArray.sort((a, b) => {
    const numA = parseInt(a.name.match(/\d+/)[0]);
    const numB = parseInt(b.name.match(/\d+/)[0]);
    return numA - numB;
  });

  // üî• ‡∏ß‡∏≤‡∏î UI ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß
  docsArray.forEach((data) => {
    const status = (data.status || "").toLowerCase().trim();

    const box = document.createElement("div");

box.innerHTML = `
  ${data.name}<br>
  ${status === "borrowed" ? 
    "üë§ " + data.borrowedBy + "<br>üïí " + data.borrowDate 
    : ""}
`;


    box.style.padding = "20px";
    box.style.textAlign = "center";
    box.style.borderRadius = "10px";
    box.style.color = "white";
    box.style.fontWeight = "bold";
    box.style.cursor = "pointer";

    if (status === "available") {
      box.style.backgroundColor = "green";
    } else {
      box.style.backgroundColor = "red";
    }

    box.onclick = async () => {
      if (!currentUser) return;

      const docRef = doc(db, "laptops", data.id);

      if (status === "available") {
        await updateDoc(docRef, {
          status: "borrowed",
          borrowedBy: currentUser.email,
          borrowDate: new Date().toLocaleString()
        });
      } else {
        if (data.borrowedBy === currentUser.email) {
          await updateDoc(docRef, {
            status: "available",
            borrowedBy: "",
            borrowDate: ""
          });
        } else {
          alert("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡πÇ‡∏î‡∏¢‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô");
        }
      }

      loadLaptops();
    };

    laptopList.appendChild(box);
  });
}
// Login
loginBtn.onclick = () => {
  signInWithPopup(auth, provider)
    .catch((error) => {
      console.log(error);
    });
};
// üî• ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ login ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
onAuthStateChanged(auth, (user) => {
  if (user && user.email.endsWith("@nairong.ac.th")) {

    currentUser = user;
    userInfo.innerHTML = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß: " + user.email;
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline";
    loadLaptops();

  } else {

    if (user) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏•‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!");
      signOut(auth);
    }

    currentUser = null;
    userInfo.innerHTML = "";
    loginBtn.style.display = "inline";
    logoutBtn.style.display = "none";
    laptopList.innerHTML = "";
  }
});


  // Logout
  logoutBtn.onclick = () => {
    signOut(auth);
    currentUser = null;
    userInfo.innerHTML = "";
    loginBtn.style.display = "inline";
    logoutBtn.style.display = "none";
    laptopList.innerHTML = "";
  };

</script>

</body>
</html>
